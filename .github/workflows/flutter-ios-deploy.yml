name: Build iOS App for App Store

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      # -------------------
      # 1. Checkout code
      # -------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------
      # 2. Setup Flutter
      # -------------------
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      - name: Flutter pub get
        run: flutter pub get

      # -------------------
      # 3. Setup Certificates & Provisioning Profile
      # -------------------
      - name: Install Distribution Certificate
        run: |
          echo "$IOS_DISTRIBUTION_CERTIFICATE_BASE64" | base64 --decode > dist.p12
          security import dist.p12 -k ~/Library/Keychains/login.keychain-db -P "$IOS_DISTRIBUTION_CERTIFICATE_PASSWORD" -T /usr/bin/codesign

      - name: Install Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/Ilolo_AppStore.mobileprovision

      # -------------------
      # 4. Inspect Provisioning Profile (debug)
      # -------------------
      - name: Inspect Provisioning Profile
        run: |
          security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/Ilolo_AppStore.mobileprovision > profile.plist
          echo "ðŸ‘‰ Provisioning Profile Info:"
          /usr/libexec/PlistBuddy -c "Print :Name" profile.plist
          /usr/libexec/PlistBuddy -c "Print :UUID" profile.plist
          /usr/libexec/PlistBuddy -c "Print :TeamIdentifier:0" profile.plist
          /usr/libexec/PlistBuddy -c "Print :Entitlements:application-identifier" profile.plist

      # -------------------
      # 5. Build iOS IPA
      # -------------------
      - name: Build iOS IPA
        run: |
          flutter build ipa --release \
            --export-options-plist=ios/exportOptions.plist

      # -------------------
      # 6. Upload Artifact
      # -------------------
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-ipa
          path: build/ios/ipa/*.ipa
